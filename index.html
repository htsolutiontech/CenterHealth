<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Center Health - @BinhMinHAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #070b14; --card-bg: #111c2e; --text-primary: #f1f5f9;
            --text-secondary: #94a3b8; --accent-cyan: #00dfee; --accent-blue: #3b82f6;
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        body { margin: 0; background-color: var(--bg-dark); color: var(--text-primary); display: flex; height: 100vh; overflow: hidden; font-size: 13px; }
        
        /* Sidebar Navigation */
        .sidebar { width: 250px; background: #0f172a; border-right: 1px solid rgba(255,255,255,0.05); padding: 20px; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .nav-item { padding: 12px 16px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
        .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent-cyan); border: 1px solid rgba(59, 130, 246, 0.2); font-weight: 700; }

        /* Main Workspace */
        .main-content { flex: 1; overflow-y: auto; padding: 25px; background: var(--bg-dark); scrollbar-width: thin; }
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* Dashboard Cards */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card-bg); border-radius: 18px; padding: 18px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .card-label { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
        .big-stats { font-size: 2.4rem; font-weight: 900; color: var(--accent-cyan); margin: 0; letter-spacing: -0.03em; }

        /* --- GIS GOOGLE MAPS DYNAMIC --- */
        .map-frame { height: 500px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; background: #000; }
        /* Tích hợp Google Maps Satellite View HCM */
        .map-google-satellite { width: 100%; height: 100%; border: 0; filter: brightness(0.6) contrast(1.1); pointer-events: all; }
        
        .map-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .amb-marker { position: absolute; padding: 8px 16px; border-radius: 50px; font-size: 0.65rem; font-weight: 900; background: var(--danger); border: 2px solid #fff; color: #fff; z-index: 50; box-shadow: 0 0 20px rgba(239,68,68,0.6); offset-path: path("M 120 450 Q 350 400 750 200"); offset-distance: 0%; display: flex; align-items: center; gap: 6px; }

        /* ECG Monitor phosphor sweep */
        .ecg-monitor { background: #000; border-radius: 15px; height: 180px; position: relative; border: 1px solid #1e293b; overflow: hidden; }
        .ecg-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(0,255,0,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,0,0.04) 1px, transparent 1px); background-size: 20px 20px; }

        /* Zalo relative panel */
        .zalo-feed { height: 210px; overflow-y: auto; background: rgba(0,0,0,0.25); border-radius: 14px; padding: 15px; font-size: 0.75rem; border: 1px solid rgba(0, 104, 255, 0.2); }
        .zalo-msg { margin-bottom: 10px; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.03); border-left: 3px solid #0068ff; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Modal Hội chẩn */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); backdrop-filter: blur(20px); z-index: 2000; display: none; }
        .modal-content { width: 98%; max-width: 1450px; height: 92vh; margin: 4vh auto; background: var(--card-bg); border: 1px solid var(--accent-cyan); border-radius: 28px; display: grid; grid-template-columns: 350px 1fr 320px; overflow: hidden; }
        .modal-pane { padding: 25px; border-right: 1px solid rgba(255,255,255,0.05); overflow-y: auto; }

        .select-bv { width: 100%; padding: 12px; background: #1e293b; border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 10px; margin-top: 10px; font-size: 0.85rem; cursor: pointer; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div style="font-weight: 900; color: var(--accent-cyan); font-size: 1.4rem; margin-bottom: 5px;"><i class="fas fa-city"></i>Center Health</div>
        <div style="font-size: 0.6rem; color: var(--success); font-weight: 800; padding-bottom: 20px;"><i class="fas fa-circle text-[6px] mr-1"></i>LIÊN THÔNG ĐA TUYẾN</div>
        <div style="font-size: 0.5rem; color: red; font-weight: 700;">@2025 BinhMinhAI</div>
        
        <nav class="space-y-1">
            <div id="nav-dash" class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-th-large"></i> Dashboard Giám sát</div>
            <div id="nav-epi" class="nav-item" onclick="switchView('epidemic', this)"><i class="fas fa-virus"></i> Phân tích Dự báo</div>
            <div id="nav-amb" class="nav-item" onclick="switchView('ambulance', this)"><i class="fas fa-map-location-dot"></i> GIS Cấp cứu Live</div>
            <div id="nav-perf" class="nav-item" onclick="switchView('performance', this)"><i class="fas fa-chart-line"></i> Hiệu suất Tuyến dưới</div>
        </nav>
    </aside>

    <main class="main-content">
        <div id="dashboard-view" class="view-section active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="font-size: 2rem; font-weight: 900; margin: 0;">ĐIỀU PHỐI Y TẾ TP.HCM</h2>
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-3 shadow-lg transition-all" onclick="openConsultation('TYT Phường Bến Nghé (Quận 1)')">
                    <i class="fas fa-video"></i> HỘI CHẨN LIÊN TUYẾN
                </button>
            </div>
            <div class="dashboard-grid">
                <div class="card"><p class="card-label">BN mạn tính (HCM)</p><p class="big-stats">12,540</p></div>
                <div class="card"><p class="card-label">Ca nguy cơ cao</p><p class="big-stats" style="color: var(--danger);">18</p></div>
                <div class="card"><p class="card-label">Accuracy Rate</p><p class="big-stats" style="color: var(--accent-blue);">91.4%</p></div>
                <div class="card"><p class="card-label">TYT Kết nối</p><p class="big-stats" style="color: var(--success);">312</p></div>
            </div>
            <div class="card"><p class="card-label">DANH SÁCH CA BỆNH BÁO ĐỘNG (REAL-TIME FEED)</p>
                <table class="custom-table" style="width:100%; border-collapse: collapse; text-align: left; font-size: 0.85rem;">
                    <thead><tr style="color: var(--text-secondary); border-bottom: 1px solid #334155;"><th style="padding: 15px;">Trạm Y tế (TYT)</th><th>Bệnh nhân</th><th>Vitals</th><th>Nguy cơ</th><th>Action</th></tr></thead>
                    <tbody id="risk-list-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="epidemic-view" class="view-section">
            <h2 style="font-size: 1.8rem; font-weight: 900; margin-bottom: 30px;">DỰ BÁO DỊCH BỆNH KHU VỰC (HCM)</h2>
            <div class="grid grid-cols-3 gap-8">
                <div class="col-span-2 card">
                    <p class="card-label">XU HƯỚNG DENGUE & TIM MẠCH VS. NHIỆT ĐỘ</p>
                    <div style="height: 350px;"><canvas id="epidemicChart"></canvas></div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #1e293b, #070b14);"><p class="card-label">Risk Level AI</p>
                    <div style="font-size: 4rem; font-weight: 900; color: var(--warning);">72%</div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 15px; line-height: 1.6;">AI phân tích: Nhiệt độ dự báo tăng nhẹ kèm độ ẩm cao. Nguy cơ bùng phát ca sốt xuất huyết tại Quận 8 tăng 25%.</p>
                </div>
            </div>
        </div>

        <div id="ambulance-view" class="view-section">
            <h2 style="font-size: 1.8rem; font-weight: 900; margin-bottom: 25px;">BẢN ĐỒ GIS CHUYỂN TUYẾN LIVE</h2>
            <div class="grid grid-cols-4 gap-8">
                <div class="col-span-3">
                    <div class="map-frame shadow-2xl">
                        <iframe class="map-google-satellite" 
                                src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d31355.63229618063!2d106.7029!3d10.7769!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e1!3m2!1svi!2s!4v1711234567890!5m2!1svi!2s&maptype=satellite" 
                                allowfullscreen="" loading="lazy"></iframe>
                        <div class="map-overlay">
                            <svg style="width:100%; height:100%;"><path id="routePath" d="M 120 450 Q 350 400 750 200" stroke="rgba(0, 223, 238, 0.4)" stroke-width="4" fill="none" stroke-dasharray="10,5" /></svg>
                            <div id="ambMarker" class="amb-marker"><i class="fas fa-ambulance"></i> AMB-HCM-01</div>
                            <div style="position: absolute; left: 100px; top: 430px; text-align: center;"><i class="fas fa-house-medical text-danger text-2xl"></i><p id="originLabel" style="font-size: 9px; font-weight: 900; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px;">TYT NGUỒN</p></div>
                            <div style="position: absolute; left: 730px; top: 180px; text-align: center;"><i class="fas fa-hospital text-sky-400 text-2xl"></i><p id="destLabel" style="font-size: 9px; font-weight: 900; background:rgba(0,0,0,0.7); padding:2px 4px; border-radius:4px;">BV TIẾP NHẬN</p></div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="card border-t-4 border-danger"><p class="card-label">CHI TIẾT ĐIỀU PHỐI AI</p>
                        <p style="font-size: 0.85rem; font-weight: 500;"><b>BV Đã chọn:</b> <span id="selectedBvName" class="text-accent-cyan">Bệnh viện Đa khoa Sài Gòn</span></p>
                        <p style="font-size: 0.85rem; font-weight: 500;"><b>Thời gian ETA:</b> <span id="eta-timer" class="text-warning font-black" style="font-size: 1.1rem;">12 PHÚT</span></p>
                        <button onclick="simulateJourney()" style="width:100%; margin-top:10px; background:var(--danger); border:none; padding:12px; color:white; border-radius:12px; font-weight:bold; cursor:pointer; text-transform:uppercase;">MÔ PHỎNG LỘ TRÌNH</button>
                    </div>
                    <div class="card"><p class="card-label">ZALO RELATIVE FEED (NGƯỜI NHÀ)</p>
                        <div id="zalo-relative-feed" class="zalo-feed"><div class="text-slate-500 italic">Chưa có thông báo...</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="performance-view" class="view-section">
            <h2 style="font-size: 1.8rem; font-weight: 900; margin-bottom: 30px;">HIỆU SUẤT PHÂN LUỒNG TUYẾN CƠ SỞ</h2>
            <div class="grid grid-cols-2 gap-10">
                <div class="card"><p class="card-label">Chuyển tuyến Đúng vs. Tránh được (TP.HCM)</p><div style="height: 350px;"><canvas id="perfChart"></canvas></div></div>
                <div class="card"><p class="card-label">Top Quận có năng lực chẩn đoán cao</p>
                    <table class="custom-table" style="width:100%;">
                        <tr style="color: var(--text-secondary); border-bottom: 1px solid #334155;"><th style="padding: 12px; text-align: left;">Quận/Huyện</th><th>Accuracy (%)</th></tr>
                        <tr><td style="padding: 12px;">Quận 1</td><td class="text-success font-bold" style="font-size: 1.1rem;">96.2%</td></tr>
                        <tr><td style="padding: 12px;">Quận 3</td><td class="text-success font-bold" style="font-size: 1.1rem;">94.8%</td></tr>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="consultModal" class="modal-overlay">
        <div class="modal-content shadow-2xl">
            <div class="modal-pane" style="background: rgba(255,255,255,0.01);">
                <h3 style="color: var(--accent-cyan); font-weight: 900; margin-bottom: 25px;"><i class="fas fa-file-medical mr-2"></i> HỒ SƠ FHIR</h3>
                <div id="patientInfo" style="font-size: 0.95rem; line-height: 2.2;"><p><b>BN:</b> Trần Văn B (58t)</p><p><b>Nguồn:</b> <span id="sourceTyt" class="text-accent-cyan font-bold">TYT Phường Bến Nghé</span></p>
                <hr style="opacity:0.1; margin: 15px 0;"><p style="color:var(--warning); font-weight:900;">AI CDSS: CHUYỂN TUYẾN KHẨN CẤP</p></div>
                
                <p class="card-label" style="margin-top: 25px;">CHỌN TUYẾN BỆNH VIỆN GẦN NHẤT (HCM)</p>
                <select id="bvDropdown" class="select-bv">
                    </select>
            </div>
            <div class="modal-pane">
                <h3 style="font-weight: 900; margin-bottom: 15px; font-size: 1rem;">IoT LIVE STREAM (ICU-01)</h3>
                <div class="ecg-monitor mb-6"><div class="ecg-grid"></div><canvas id="ecgCanvas" width="850" height="180" style="position: absolute;"></canvas></div>
                <div class="card" style="background: rgba(0,0,0,0.4); height: 260px;"><canvas id="modalVitalChart"></canvas></div>
            </div>
            <div class="modal-pane" style="background: rgba(0,0,0,0.2);">
                <h3 style="font-weight: 900; margin-bottom: 20px;">HỘI CHẨN CHUYÊN GIA</h3>
                <div id="chat" style="height: 380px; font-size: 0.9rem; display: flex; flex-direction: column; gap: 12px; overflow-y: auto;">
                    <div class="bg-blue-600/10 p-4 rounded-xl border-l-3 border-sky-400"><b>BS. TYT:</b> BN đau ngực cấp, SpO2 91%. ST chênh lên rõ.</div>
                    <div class="bg-white/5 p-4 rounded-xl"><b>Chuyên gia:</b> Đồng ý lệnh chuyển tuyến. Đã chuẩn bị kíp trực đón BN.</div>
                </div>
                <button class="w-full py-5 bg-red-600 hover:bg-red-700 text-white font-black rounded-2xl uppercase shadow-2xl transition-all" onclick="dispatchAmbulance()">PHÁT LỆNH & ĐIỀU XE</button>
            </div>
        </div>
    </div>

    <script>
        let journeyInt = null;

        // --- Data Mocking from HCM Files ---
        const hcmTytList = ["TYT P. Bến Nghé (Quận 1)", "TYT P. Đa Kao (Quận 1)", "TYT Phường 8 (Quận 3)", "TYT P. Võ Thị Sáu (Quận 3)", "TYT Phường 12 (Quận 10)"];
        const hcmBvList = ["Bệnh viện Đa khoa Sài Gòn", "Bệnh viện Quận 1", "Bệnh viện Quận 3", "Bệnh viện Chợ Rẫy", "Bệnh viện Nhân dân 115", "Bệnh viện Từ Dũ", "Bệnh viện Hùng Vương"];

        function switchView(id, el) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(id + '-view').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(id === 'epidemic') initEpidemicChart();
            if(id === 'performance') initPerformanceChart();
        }

        function initECG() {
            const canvas = document.getElementById('ecgCanvas');
            const ctx = canvas.getContext('2d');
            let x = 0;
            function sweep() {
                ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2.5; ctx.shadowBlur = 10; ctx.shadowColor = '#00ff00';
                ctx.beginPath(); ctx.moveTo(x, 90);
                x += 3;
                const peak = Math.random() > 0.96 ? (Math.random() > 0.5 ? -60 : 60) : (Math.random()-0.5)*10;
                ctx.lineTo(x, 90 + peak); ctx.stroke();
                ctx.clearRect(x + 5, 0, 40, 180);
                if(x > canvas.width) x = 0;
                requestAnimationFrame(sweep);
            }
            sweep();
        }

        function addZaloMsg(msg) {
            const feed = document.getElementById('zalo-relative-feed');
            const div = document.createElement('div');
            div.className = 'zalo-msg';
            div.innerHTML = `<b>Zalo (Tuyến tỉnh):</b> ${msg} <br><small class="text-slate-500">${new Date().toLocaleTimeString()}</small>`;
            feed.prepend(div);
        }

        function simulateJourney() {
            if (journeyInt) clearInterval(journeyInt);
            const marker = document.getElementById('ambMarker');
            const eta = document.getElementById('eta-timer');
            marker.style.offsetDistance = '0%';
            let pos = 0;
            addZaloMsg("Xe cấp cứu AMB-HCM-01 đã nhận nhiệm vụ chuyển viện.");
            
            journeyInt = setInterval(() => {
                pos += 1; marker.style.offsetDistance = pos + '%';
                if (pos % 12 === 0 && pos < 90) {
                    let cur = parseInt(eta.innerText);
                    if (cur > 1) eta.innerText = (cur - 1) + " PHÚT";
                }
                if(pos >= 100) { 
                    clearInterval(journeyInt); 
                    marker.innerHTML = '● ĐÃ ĐẾN NƠI'; marker.style.background = '#22c55e';
                    eta.innerText = "ĐÃ TIẾP NHẬN";
                    addZaloMsg("Bệnh nhân đã về đến bệnh viện tiếp nhận an toàn.");
                }
            }, 100);
        }

        function dispatchAmbulance() {
            const bv = document.getElementById('bvDropdown').value;
            alert(`LỆNH PHÁT THÀNH CÔNG!\nBệnh nhân đang được chuyển đến ${bv}.`);
            document.getElementById('selectedBvName').innerText = bv;
            document.getElementById('destLabel').innerText = bv;
            closeModal();
            switchView('ambulance', document.getElementById('nav-amb'));
            setTimeout(simulateJourney, 1000);
        }

        function initEpidemicChart() {
            new Chart(document.getElementById('epidemicChart'), {
                type: 'bar',
                data: {
                    labels: ['Th2','Th3','Th4','Th5','Th6','Th7','CN'],
                    datasets: [
                        { label: 'Số ca mạn tính bùng phát', data: [15,22,38,55,45,30,18], backgroundColor: 'rgba(239,68,68,0.6)' },
                        { label: 'Nhiệt độ (°C)', data: [34,32,28,24,25,29,32], borderColor: '#f59e0b', type: 'line', yAxisID: 'y1', tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y1: { position: 'right', grid: { display: false } } } }
            });
        }

        function initPerformanceChart() {
            new Chart(document.getElementById('perfChart'), {
                type: 'bar',
                data: {
                    labels: ['Quận 1','Quận 3','Quận 10','Bình Thạnh'],
                    datasets: [
                        { label: 'Chuyển tuyến Đúng', data: [405,342,282,155], backgroundColor: '#22c55e' },
                        { label: 'Ca tránh được', data: [15,8,13,25], backgroundColor: '#ef4444' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { stacked: true }, x: { stacked: true } } }
            });
        }

        function populateHCMLists() {
            const tbody = document.getElementById('risk-list-body');
            tbody.innerHTML = hcmTytList.map((tyt, i) => `
                <tr style="border-bottom:1px solid #1e293b;"><td style="padding:15px;"><b>${tyt}</b></td><td>Nguyễn Văn ${String.fromCharCode(65+i)}</td><td class="text-danger">BP 175/105</td><td><span class="text-danger font-bold">Critical</span></td><td><button onclick="openConsultation('${tyt}')" class="text-sky-400 font-bold hover:underline">Hội chẩn</button></td></tr>
            `).join('');

            const select = document.getElementById('bvDropdown');
            select.innerHTML = hcmBvList.map(bv => `<option value="${bv}">${bv}</option>`).join('');
        }

        function openConsultation(tyt) { 
            document.getElementById('sourceTyt').innerText = tyt;
            document.getElementById('originLabel').innerText = tyt;
            document.getElementById('consultModal').style.display='block'; 
            initECG(); 
        }
        function closeModal() { document.getElementById('consultModal').style.display='none'; }
        
        populateHCMLists();
    </script>
</body>

</html>
